<!DOCTYPE html>
<html>

<head>
    {% load static %}
    <!-- å¼•å…¥å›¾æ ‡æ ·å¼ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/simple-line-icons@2.5.5/css/simple-line-icons.css" rel="stylesheet">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="{% static 'css/components.chunk.css' %}">
    <link rel="stylesheet" href="{% static 'css/umi.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="{% static 'js/custom.js' %}"></script>
    <script src="{% static 'js/echarts.min.js' %}"></script>

    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="theme-color" content="#343a40">

    <title>æ™ºæ…§åŒ»ç–—é—®ç­”ç³»ç»Ÿ</title>
</head>

<body>
    <script defer>
        // è·å–å½“å‰æ—¥æœŸå¹¶æ›´æ–°åˆ°é¡µé¢ä¸Š
        function updateDate() {
            const currentDate = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            const formattedDate = currentDate.toLocaleDateString('zh-CN', options);
            document.getElementById('current-date').textContent = formattedDate;
        }

        // å®æ—¶æ›´æ–°æ—¥æœŸ
        setInterval(updateDate, 300); // æ¯éš”300msæ›´æ–°ä¸€æ¬¡æ—¥æœŸ
    </script>

    <div id="root">
        <div id="page-container" class="null sidebar-o sidebar-dark page-header-dark side-scroll page-header-fixed main-content-boxed side-trans-enabled false">
            <div class="v2board-nav-mask" style="display: none;"></div>
            <nav id="sidebar">
                <div class="smini-hidden bg-header-dark">
                    <div class="content-header justify-content-lg-center bg-white-10"><a class="font-size-lg text-white" href="/medical/homepage/"><span class="text-white-75">æ™ºæ…§åŒ»ç–—é—®ç­”ç³»ç»Ÿ</span></a>
                        <div class="d-lg-none"><a class="text-white ml-2" data-toggle="layout" data-action="sidebar_close" href="javascript:void(0);"><i class="fa fa-times-circle"></i></a></div>
                    </div>
                </div>
                <div class="content-side content-side-full">
                    <ul class="nav-main">
                        <li class="nav-main-heading">æ¬¢è¿å…‰ä¸´</li>
                        <li class="nav-main-item"><a class="nav-main-link false"><i class="nav-main-link-icon si si-book-open"></i><span class="nav-main-link-name">ä¸»é¡µ</span></a></li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/instruction/"><i class="nav-main-link-icon si si-book-open"></i><span class="nav-main-link-name">ä½¿ç”¨è¯´æ˜</span></a></li>
                        <li class="nav-main-heading">åŠŸèƒ½</li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/guess/"><i class="nav-main-link-icon si si-question"></i><span class="nav-main-link-name">çŒœä½ æ‰€æƒ³</span></a></li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/microscope/"><i class="nav-main-link-icon si si-question"></i><span class="nav-main-link-name">ç—…ç—›æ˜¾å¾®é•œ</span></a></li>
                        <li class="nav-main-item"><a class="nav-main-link active" href="/medical/inquiry/"><i class="nav-main-link-icon si si-question"></i><span class="nav-main-link-name">é¾™çµé—®ç–¾</span></a></li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/inquiryplus/"><i class="nav-main-link-icon si si-question"></i><span class="nav-main-link-name">é¾™çµé—®ç–¾ï¼ˆPlus Betaï¼‰</span></a></li>
                        <li class="nav-main-heading">ç”¨æˆ·</li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/user/"><i class="nav-main-link-icon si si-users"></i><span class="nav-main-link-name">ç”¨æˆ·ä¸­å¿ƒ</span></a></li>
                        <li class="nav-main-heading">å…³äº</li>
                        <li class="nav-main-item"><a class="nav-main-link false" href="/medical/illustration/"><i class="nav-main-link-icon si si-book-open"></i><span class="nav-main-link-name">è¯´æ˜</span></a></li>

                    </ul>
                </div>
                <div class="v2board-copyright">æ™ºæ…§åŒ»ç–—é—®ç­”ç³»ç»Ÿ v1.0.0</div>
            </nav>
            <header id="page-header">
                <div class="content-header">
                    <div class="sidebar-toggle" style="display: none;"><button type="button" class="btn btn-primary mr-1 d-lg-none"><i class="fa fa-fw fa-bars"></i></button></div>
                    <div class="v2board-container-title text-white">é¾™çµé—®ç–¾</div>
                    <div>
                        <div class="dropdown d-inline-block">
                            <button type="button" class="btn btn-primary dropdown-button">
                                <i class="far fa fa-user-circle"></i>
                                <span class="d-none d-lg-inline ml-1">{{ user_info.username }}</span>
                                <i class="fa fa-fw fa-angle-down ml-1"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-right p-0 false">
                                <div class="p-2">
                                    <a class="dropdown-item" href="/medical/user/">
                                        <i class="far fa-fw fa-user mr-1"></i> ç”¨æˆ·ä¸­å¿ƒ
                                    </a>
                                    <a class="dropdown-item" href="/medical/login/">
                                        <i class="far fa-fw fa-arrow-alt-circle-left mr-1"></i> ç™»å‡º
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <main id="main-container">
                <div class="content content-full">
                    <div class="row mb-3 mb-md-0">
                        <div class="col-md-12">
                            <section class="msger">
                                <header class="msger-header">
                                    <div class="msger-header-title">
                                        <i class="fas fa-comment-alt"></i> é¾™çµ
                                    </div>
                                    <div class="msger-header-options">
                                        <span><i class="fas fa-cog"></i></span>
                                    </div>
                                </header>

                                <main class="msger-chat">
                                    <div class="msg left-msg">
                                        <div class="msg-img" style="background-image: url(https://chat.openai.com/favicon.ico)"></div>

                                        <div class="msg-bubble">
                                            <div class="msg-info">
                                                <div class="msg-info-name">é¾™çµ</div>
                                                <div class="msg-info-time">
                                                    <a id="current-time"></a>
                                                </div>
                                            </div>

                                            <div class="msg-text">
                                                æ¬¢è¿æ¥åˆ°é¾™çµé—®ç–¾ï¼Œåœ¨æ­¤è¾“å…¥ä½ çš„æè¿°ä¿¡æ¯ï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºä½ è§£ç­”ã€‚èœå•é¡¹å¯ä»¥é€‰æ‹©è¾“å…¥çš„æ ¼å¼å“¦ï¼Œä¼šé‡‡ç”¨æ›´åŠ åŒ¹é…çš„æ™ºèƒ½ç®—æ³•å»è¿›è¡Œæœç´¢ï¼ğŸ˜„
                                            </div>
                                        </div>
                                    </div>

                                    <div class="msg right-msg">
                                        <div class="msg-img" style="background-image: url(/static/image/user.jpg)"></div>

                                        <div class="msg-bubble">
                                            <div class="msg-info">
                                                <div class="msg-info-name">ç”¨æˆ·</div>
                                                <div class="msg-info-time">
                                                    <a id="current-time"></a>
                                                </div>
                                            </div>
                                            <div class="msg-text">
                                                é¾™çµå°å§å§ä½ å¥½å‘€ï¼Œæˆ‘æƒ³é—®ä¸€äº›é—®é¢˜å–”ï¼
                                            </div>
                                        </div>
                                    </div>
                                </main>

                                <div class="msger-inputarea">
                                    <input type="text" id="disease-input" class="msger-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥ç–¾ç—…" onkeydown="handleEnter(event)">
                                    <input type="text" id="drug-input" class="msger-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥è¯å“" onkeydown="handleEnter(event)">
                                    <input type="text" id="symptom-input" class="msger-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥ç—‡çŠ¶" onkeydown="handleEnter(event)">
                                    <select id="switch">
                                        <option value="True">å…³é”®è¯</option>
                                        <option value="False">æ–‡æœ¬</option>
                                    </select>
                                    <button type="submit" class="msger-send-btn" onclick="sendMessage()">å‘é€</button>

                                </div>
                            </section>
                        </div>
                    </div>
                </div>
        </div>
        </main>
    </div>
    </div>
    <script>
        const msgerForm = get(".msger-inputarea");
        const msgerInput = get(".msger-input");
        const msgerChat = get(".msger-chat");
        const BOT_IMG = "https://chat.openai.com/favicon.ico";
        const PERSON_IMG = "/static/image/user.jpg";
        const BOT_NAME = "é¾™çµ";
        const PERSON_NAME = "ç”¨æˆ·";

        function handleEnter(event) {
            if (event.keyCode === 13) {
                sendMessage();
            }
        }

        // æ·»åŠ  sendMessage å‡½æ•°
        function sendMessage() {
            event.preventDefault();
            const diseaseInput = document.getElementById('disease-input');
            const diseasetext = diseaseInput.value.trim()
            const drugInput = document.getElementById('drug-input');
            const drugtext = drugInput.value.trim()
            const symptomInput = document.getElementById('symptom-input');
            const symptomtext = symptomInput.value.trim()

            if (diseasetext == '' && drugtext == '' && symptomtext == '') {
                alert('è¾“å…¥æ¡†ç©ºç™½ï¼Œè¯·è¾“å…¥');
                return;
            }

            // è·å–ä¸‹æ‹‰èœå•çš„é€‰é¡¹å€¼
            const switchmessage = document.getElementById('switch').value;

            appendMessage(PERSON_NAME, PERSON_IMG, "right", "ç–¾ç—…ï¼š" + diseasetext + "ï¼›è¯å“ï¼š" + drugtext + "ï¼›ç—‡çŠ¶ï¼š" + symptomtext);
            // ä½¿ç”¨ fetch æ–¹æ³•å‘é€ POST è¯·æ±‚
            fetch('/medical/inquiry/', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        'X-CSRFToken': getCookie('csrftoken'), // è·å–å¹¶è®¾ç½®CSRFä»¤ç‰Œ
                    },
                    body: JSON.stringify({
                        disease: diseasetext,
                        drug: drugtext,
                        symptom: symptomtext,
                        switch: switchmessage,
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // åœ¨æ”¶åˆ°å“åº”åå¤„ç†åç«¯çš„å›å¤
                    const botResponse = data.message;
                    const linkList = botResponse.map(item => `<a href="http://127.0.0.1:8000/medical/microscope/${encodeURIComponent(item)}">${item}</a>`).join('<br>');
                    const messageText = `è¿™æ˜¯çµçµæ‰¾åˆ°çš„ç›¸å…³ç–¾ç—…ï¼Œå¦‚æœå¯¹æ‚¨æœ‰å¸®åŠ©çµçµå°±ä¼šååˆ†å¼€å¿ƒå‘€ï¼š<br>${linkList}<br>ç‚¹å‡»é“¾æ¥æ—¢å¯ä»¥æŸ¥çœ‹åˆ°ç–¾ç—…çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ„Ÿè°¢ä½¿ç”¨å“¦ï¼`;
                    appendMessage(BOT_NAME, BOT_IMG, "left", messageText);
                })
                .catch(error => {
                    console.error("å‘é€è¯·æ±‚æ—¶å‡ºç°é”™è¯¯:", error);
                });
            diseaseInput.value = "";
            drugInput.value = "";
            symptomInput.value = "";
        }


        function appendMessage(name, img, side, text) {
            //   Simple solution for small apps
            const msgHTML = `
            <div class="msg ${side}-msg">
            <div class="msg-img" style="background-image: url(${img})"></div>

            <div class="msg-bubble">
                <div class="msg-info">
                <div class="msg-info-name">${name}</div>
                <div class="msg-info-time">${formatDate(new Date())}</div>
                </div>

                <div class="msg-text">${text}</div> 
                </div> 
                </div>
            `;
            msgerChat.insertAdjacentHTML("beforeend", msgHTML);
            msgerChat.scrollTop += 500;
        }

        // Utils
        // è·å–å¹¶è®¾ç½®CSRFä»¤ç‰Œ
        function getCookie(name) {
            const value = `;
            $ {
                document.cookie
            }
            `;
            const parts = value.split(`;
            $ {
                name
            } = `);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function get(selector, root = document) {
            return root.querySelector(selector);
        }

        function formatDate(date) {
            const h = "0" + date.getHours();
            const m = "0" + date.getMinutes();
            return `${h.slice(-2)}:${m.slice(-2)}`;
        }
    </script>
</body>

</html>